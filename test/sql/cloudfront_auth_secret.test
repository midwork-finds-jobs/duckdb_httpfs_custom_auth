# name: test/sql/cloudfront_auth_secret.test
# description: test cloudfront_auth secret creation with test key
# group: [cloudfront_auth]

require cloudfront_auth

require noforcestorage

# Create a valid cloudfront secret with test key (using PRIVATE_KEY_PATH)
statement ok
CREATE SECRET cf_test (
    TYPE cloudfront,
    KEY_PAIR_ID 'TESTKEYPAIRID123',
    PRIVATE_KEY_PATH '__WORKING_DIRECTORY__/test/data/test_private_key.pem',
    SCOPE 'https://test.cloudfront.net/'
);

# Verify secret was created
query I
SELECT count(*) FROM duckdb_secrets() WHERE name = 'cf_test';
----
1

# Verify secret has correct type (internally http for httpfs compatibility)
query I
SELECT type FROM duckdb_secrets() WHERE name = 'cf_test';
----
http

# Verify secret has correct scope
query I
SELECT scope FROM duckdb_secrets() WHERE name = 'cf_test';
----
['https://test.cloudfront.net/']

# Verify secret contains CloudFront cookies in extra_http_headers
query I
SELECT secret_string LIKE '%CloudFront-Policy=%' FROM duckdb_secrets() WHERE name = 'cf_test';
----
true

query I
SELECT secret_string LIKE '%CloudFront-Signature=%' FROM duckdb_secrets() WHERE name = 'cf_test';
----
true

query I
SELECT secret_string LIKE '%CloudFront-Key-Pair-Id=TESTKEYPAIRID123%' FROM duckdb_secrets() WHERE name = 'cf_test';
----
true

# Test with optional parameters
statement ok
CREATE OR REPLACE SECRET cf_test_opts (
    TYPE cloudfront,
    KEY_PAIR_ID 'TESTKEYPAIRID456',
    PRIVATE_KEY_PATH '__WORKING_DIRECTORY__/test/data/test_private_key.pem',
    SCOPE 'https://test2.cloudfront.net/',
    RESOURCE_PATTERN 'api/*',
    EXPIRATION_HOURS 48
);

query I
SELECT count(*) FROM duckdb_secrets() WHERE name = 'cf_test_opts';
----
1

# Verify the key pair ID in the cookie
query I
SELECT secret_string LIKE '%CloudFront-Key-Pair-Id=TESTKEYPAIRID456%' FROM duckdb_secrets() WHERE name = 'cf_test_opts';
----
true

# Test DROP SECRET
statement ok
DROP SECRET cf_test;

query I
SELECT count(*) FROM duckdb_secrets() WHERE name = 'cf_test';
----
0

# Test error: non-existent private key file
statement error
CREATE SECRET cf_bad_path (
    TYPE cloudfront,
    KEY_PAIR_ID 'TESTKEYPAIRID',
    PRIVATE_KEY_PATH '/nonexistent/path/to/key.pem',
    SCOPE 'https://example.cloudfront.net/'
);
----
IO Error: Cannot open private key file
